---
- name: Install Docker
  hosts: ipsk
  become: yes
  become_method: sudo
  gather_facts: false
  vars:
    ansible_ssh_user: "{{ ise_username }}"
    ansible_ssh_private_key_file: "{{ ssh_key_private_file }}"
    ansible_python_interpreter: /usr/bin/python3.10
  vars_files:
    - ../vars/linux.yaml
    - ../vars/banners.yaml
    - ../vars/date_time.yaml

  tasks:

    - name: Update all packages to their latest version
      ansible.builtin.apt:
        name: "*"
        state: latest
      register: output

    - name: Check if a reboot is required.
      ansible.builtin.stat:
        path: /var/run/reboot-required
        get_md5: no
      register: reboot_required_file

    - name: Reboot the server (if required).
      ansible.builtin.reboot:
      when: reboot_required_file.stat.exists == true

    - name: Remove dependencies that are no longer required.
      ansible.builtin.apt:
        autoremove: yes

    - name: Download the MySQL repository to the `downloads` folder
      ansible.builtin.get_url:
        url: https://dev.mysql.com/get/mysql-apt-config_0.8.12-1_all.deb
        dest: /home/iseadmin/downloads/

    - name: Install the MySQL package
      ansible.builtin.apt:
        name: /home/iseadmin/downloads/dpkg -i mysql-apt-config_0.8.12-1_all.deb

    - name: Set up the Docker Repository
      ansible.builtin.shell:
        cmd: |
          echo \
            deb [arch="$(dpkg --print-architecture)" signed-by=/etc/apt/kyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
            $(. /etc/os-release && echo "$VERSION_CODENAME") stable | \
            sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

    - name: Install Docker
      ansible.builtin.apt:
        name: docker

    - name: Install Docker Compose
      ansible.builtin.apt:
        name: docker-compose

    - name: Start service docker, if not started
      ansible.builtin.service:
        name: docker
        state: started

    - name: Enable service docker to launch on boot
      ansible.builtin.service:
        name: docker
        enabled: yes

    - name: Ensure group 'docker' exists
      ansible.builtin.group:
        name: docker
        state: present

    - name: Add the user 'iseadmin' to 'docker' group
      ansible.builtin.user:
        name: iseadmin
        groups: docker
        append: yes

    - name: Restart service docker
      ansible.builtin.service:
        name: docker
        state: restarted

    - name: Docker has been installed
      ansible.builtin.debug:
        msg: |
               ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⣦⣦⣦⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
            ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢨⣯⣇⣇⢇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
            ⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⣦⣦⣦⠀⣦⣦⣦⣦⢀⣦⣦⣦⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
            ⠀⠀⠀⠀⠀⠀⠀⠀⠀⢪⣇⣇⣇⠀⢯⣇⣇⣇⢀⣯⣇⣇⢇⠀⠀⠀⠀⠀⠀⠀⣰⣯⣧⣄⠀⠀⠀⠀⠀⠀
            ⠀⠀⠀⠀⢠⣦⣦⣦⣄⣠⣦⣦⣦⠀⣦⣦⣦⣦⢠⣦⣦⣦⣄⢠⣦⣦⣦⢀⠀⢀⣯⣇⣇⣧⣆⢀⢀⢀⠀⠀
            ⠀⠀⠀⠀⢸⣏⣇⣇⡃⢪⣇⣇⣇⠀⢫⣇⣇⣇⢀⣯⣇⣇⢇⢸⣇⣇⣇⠀⠀⠀⢫⣇⣇⣇⣯⣯⣯⣯⣯⡆
            ⠀⢠⣦⣦⣦⣦⣦⣦⣦⣦⣦⣦⣦⣦⣦⣦⣦⣦⣦⣦⣦⣦⣦⣦⣦⣦⣦⣦⣦⣦⣮⣇⣇⣇⣇⣇⢏⠏⠁⠀
            ⠀⢪⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⠃⠀⠀⠀⠀⠀⠀
            ⠀⢸⣯⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⠃⠀⠀⠀⠀⠀⠀⠀
            ⠀⠀⢫⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⢏⠁⠀⠀⠀⠀⠀⠀⠀⠀
            ⠀⠀⠈⢫⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⠏⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
            ⠀⠀⠀⠀⠋⢯⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣇⣯⠏⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
            ⠀⠀⠀⠀⠀⠀⠈⠋⠋⢫⢫⢯⢯⢯⢯⢯⢯⢯⢏⠏⠏
           
             Docker has been installed on {{ inventory_hostname }}